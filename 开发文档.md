好，下面是定制化情人节贺卡生成器的开发文档，帮助你快速实现该H5手机Web应用。

---

## **项目概述**

这个应用旨在让用户快速生成定制化的情人节贺卡。用户可以上传自己和老婆的照片，并选择一些浪漫的祝福语，生成一个带有个人化内容的电子贺卡。贺卡可以下载或分享给他人。

## **技术栈**
- **前端**: `astro` + `TailwindCSS`
- **后端**: `Node.js` (API 服务)
- **数据库**: `PostgreSQL`
- **图床**: `Cloudinary`
- **部署**: `Vercel`

## **功能需求**

1. **用户上传照片**:
   - 用户上传自己和老婆的照片，用于定制化贺卡。
   - 图片上传后存储在 Cloudinary 上，返回图片的 URL。

2. **自定义祝福语**:
   - 提供多个祝福语模板供用户选择。
   - 用户可以自定义输入文本，选择文字字体、颜色、背景等样式。

3. **生成贺卡**:
   - 将用户上传的照片和祝福语合成成一张贺卡。
   - 允许用户选择不同的模板和设计。

4. **保存与分享**:
   - 用户生成贺卡后，可以下载或通过链接分享。
   - 保存生成的贺卡记录在数据库中，方便后续管理。

## **数据库设计**

**1. 表结构 - `cards`**:

| 字段            | 类型         | 说明                         |
|-----------------|--------------|------------------------------|
| `id`            | `serial`     | 主键，自增                   |
| `user_id`       | `int`        | 用户ID (外键，指向用户表)    |
| `image_url`     | `varchar(255)`| 图片URL（存储在Cloudinary）   |
| `message`       | `text`       | 自定义祝福语                 |
| `created_at`    | `timestamp`  | 创建时间                     |
| `updated_at`    | `timestamp`  | 更新时间                     |

**2. 表结构 - `users`**:

| 字段            | 类型         | 说明                         |
|-----------------|--------------|------------------------------|
| `id`            | `serial`     | 主键，自增                   |
| `username`      | `varchar(50)`| 用户名                       |
| `email`         | `varchar(100)`| 用户邮箱                     |
| `password_hash` | `varchar(255)`| 密码哈希                     |
| `created_at`    | `timestamp`  | 创建时间                     |
| `updated_at`    | `timestamp`  | 更新时间                     |

## **前端开发流程**

### **1. 项目初始化**
使用 `create-t3-turbo` 初始化项目：

```bash
npx create-t3-turbo@latest valentines-card-generator
cd valentines-card-generator
npm install
```

### **2. 设置 TailwindCSS**
在项目中启用 TailwindCSS：

```bash
npx tailwindcss init
```

配置 `tailwind.config.js`：

```javascript
module.exports = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

### **3. 创建页面**
- **首页 (`index.tsx`)**: 提供图片上传、祝福语选择、模板选择的界面。
- **生成页面 (`generate.tsx`)**: 显示生成的贺卡，可以下载或分享。
- **后台管理页面 (`admin.tsx`)**: 查看所有生成的贺卡记录（可选）。

### **4. 图片上传功能**
使用 Cloudinary 提供的 API 来上传图片，后端会返回一个图片 URL。

前端上传功能示例（使用 Cloudinary 的 JavaScript SDK）：

```tsx
import { useState } from "react";
import { v2 as cloudinary } from "cloudinary";

const uploadImage = async (file: File) => {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "valentines_card_preset");
  
  const res = await fetch("https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload", {
    method: "POST",
    body: formData,
  });
  const data = await res.json();
  return data.secure_url;
};
```

### **5. 生成贺卡**
生成贺卡的过程可以通过 `canvas` 来实现，结合上传的图片和选择的祝福语模板，生成最终的图像。

```tsx
const generateCard = (imageUrl: string, message: string) => {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const img = new Image();
  img.src = imageUrl;
  img.onload = () => {
    // 生成贺卡，绘制图片和文字
    ctx.drawImage(img, 0, 0);
    ctx.font = "30px Arial";
    ctx.fillText(message, 50, 50); // 添加祝福语
  };
  return canvas.toDataURL(); // 返回贺卡的base64图像数据
};
```

### **6. 发布到 Vercel**
- 安装 Vercel CLI：

```bash
npm i -g vercel
```

- 登录并部署：

```bash
vercel login
vercel
```

## **后端开发流程**

### **1. 设置 PostgreSQL 数据库**

可以使用 `pg` 库来连接 PostgreSQL，创建用于存储用户和贺卡记录的表。

安装 `pg`：

```bash
npm install pg
```

配置连接：

```ts
import { Client } from "pg";

const client = new Client({
  host: "your-database-host",
  port: 5432,
  user: "your-db-user",
  password: "your-db-password",
  database: "valentines_db",
});

client.connect();
```

### **2. API 路由**
- **POST `/api/upload-image`**: 接收图片并上传到 Cloudinary。
- **POST `/api/generate-card`**: 接收生成贺卡的请求，并将生成的贺卡保存到数据库。

### **3. 数据库交互**
保存生成的贺卡：

```ts
const saveCard = async (userId: number, imageUrl: string, message: string) => {
  const query = `INSERT INTO cards (user_id, image_url, message) VALUES ($1, $2, $3) RETURNING *`;
  const values = [userId, imageUrl, message];

  const res = await client.query(query, values);
  return res.rows[0];
};
```

## **部署**

1. 将前端和后端一起部署到 Vercel。
2. 配置数据库和 Cloudinary。

---

### **开发时间预估**
- **前端开发**：2-3天
- **后端开发**：2天
- **测试与修复**：1-2天
- **部署与上线**：1天

---

如果有任何问题，或者需要进一步的代码支持，随时告诉我！加油，祝你在情人节给老婆带来一个大大的惊喜！🎉